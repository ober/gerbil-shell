#!/bin/sh
# gsc wrapper that injects gambitgsc .c files into gsc -link calls.
# This ensures the gambitgsc modules appear in the initialization chain,
# making compile-file available at runtime in the linked binary.
#
# Usage: GERBIL_GSC=/path/to/this/script gerbil build
#
# CRITICAL: gambitgsc .c files must be injected BEFORE the last argument
# of gsc -link, because gsc derives the output linkfile name from the
# last input file (e.g., gsh__exe.scm -> gsh__exe_.c).
#
# CRITICAL: modules must be listed in dependency order (from LINK_ORDER),
# NOT alphabetical. Wrong order causes segfaults during module init.
#
# gsc -link with incremental linking generates sub-linkfiles in the
# gambitgsc directory. We delete them after the link step to prevent
# duplicate symbol errors at final link time.

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
GAMBITGSC_DIR="$PROJECT_DIR/_vendor/gambitgsc"

# Find the real gsc
if [ -n "$GERBIL_HOME" ]; then
  REAL_GSC="$GERBIL_HOME/bin/gsc"
elif [ -x /opt/gerbil/bin/gsc ]; then
  REAL_GSC=/opt/gerbil/bin/gsc
else
  REAL_GSC="$(which gsc 2>/dev/null)"
fi

if [ ! -x "$REAL_GSC" ]; then
  echo "gsc-with-gambitgsc: cannot find real gsc" >&2
  exit 1
fi

# Check if this is a -link call
is_link=false
for arg in "$@"; do
  if [ "$arg" = "-link" ]; then
    is_link=true
    break
  fi
done

if $is_link && [ -d "$GAMBITGSC_DIR" ] && [ -f "$GAMBITGSC_DIR/LINK_ORDER" ]; then
  # Build ordered list of gambitgsc .c files from LINK_ORDER
  gambitgsc_files=""
  while IFS= read -r f; do
    case "$f" in ''|'#'*) continue ;; esac
    gambitgsc_files="$gambitgsc_files $GAMBITGSC_DIR/$f"
  done < "$GAMBITGSC_DIR/LINK_ORDER"

  # Separate head args (all but last) and last arg.
  # gsc -link args are flags and file paths (no spaces), so word splitting is safe.
  last_arg=
  prev_args=
  for arg in "$@"; do
    if [ -n "$last_arg" ]; then
      prev_args="$prev_args $last_arg"
    fi
    last_arg="$arg"
  done

  # shellcheck disable=SC2086
  "$REAL_GSC" $prev_args $gambitgsc_files "$last_arg"
  rc=$?

  # Clean up sub-linkfiles generated in the gambitgsc directory
  rm -f "$GAMBITGSC_DIR"/*_.c "$GAMBITGSC_DIR"/*_.o
  rm -f "$GAMBITGSC_DIR"/*__.c "$GAMBITGSC_DIR"/*__.o

  exit $rc
else
  exec "$REAL_GSC" "$@"
fi
